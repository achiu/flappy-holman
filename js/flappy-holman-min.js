var DEBUG,FLAP,GAME_HEIGHT,GRAVITY,GROUND_HEIGHT,GROUND_Y,HEIGHT,OPENING,SCALE,SPAWN_RATE,SPEED,WIDTH,WebFontConfig,bg,streetSign,bird,credits,deadInvs,deadTubeBottoms,deadTubeTops,fallSnd,flapSnd,floor,gameOver,gameOverText,gameStarted,ground,instText,invs,main,parent,score,scoreSnd,scoreText,swooshSnd,tubes,tubesTimer;DEBUG=false;SPEED=120;GRAVITY=700;FLAP=260;SPAWN_RATE=1/1500;OPENING=151;SCALE=1;HEIGHT=384;WIDTH=288;GAME_HEIGHT=336;GROUND_HEIGHT=64;GROUND_Y=HEIGHT-GROUND_HEIGHT;parent=document.querySelector("#flappy-holman");gameStarted=void 0;gameOver=void 0;deadTubeTops=[];deadTubeBottoms=[];deadInvs=[];bg=null;streetSign=null;credits=null;tubes=null;invs=null;bird=null;ground=null;score=null;scoreText=null;instText=null;gameOverText=null;flapSnd=null;scoreSnd=null;fallSnd=null;swooshSnd=null;tubesTimer=null;floor=Math.floor;main=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h;a=function(e,t){var n,i,s;n=null;i=t?"tubeTop":"tubeBottom";if(t){s=floor(e-OPENING/2-320)}else{s=floor(e+OPENING/2)}if(deadTubeTops.length>0&&i==="tubeTop"){n=deadTubeTops.pop().revive();n.reset(r.world.width,s)}else if(deadTubeBottoms.length>0&&i==="tubeBottom"){n=deadTubeBottoms.pop().revive();n.reset(r.world.width,s)}else{n=tubes.create(r.world.width,s,i);n.body.allowGravity=false}n.body.velocity.x=-SPEED;return n};f=function(){var e,t,n,i;tubes.forEachAlive(function(e){if(e.x+e.width<r.world.bounds.left){if(e.key==="tubeTop"){deadTubeTops.push(e.kill())}if(e.key==="tubeBottom"){deadTubeBottoms.push(e.kill())}}});invs.forEachAlive(function(e){if(e.x+e.width<r.world.bounds.left){deadInvs.push(e.kill())}});i=r.world.height/2+(Math.random()-.5)*r.world.height*.2;e=a(i);n=a(i,true);if(deadInvs.length>0){t=deadInvs.pop().revive().reset(n.x+n.width/2,0)}else{t=invs.create(n.x+n.width/2,0);t.width=2;t.height=r.world.height;t.body.allowGravity=false}t.body.velocity.x=-SPEED};e=function(e,t){invs.remove(t);score+=1;scoreText.setText(score);scoreSnd.play()};u=function(){var e;gameOver=true;if(bird.body.velocity.y>0){bird.body.velocity.y=100}bird.animations.stop();bird.frame=1;instText.setText("Touch @holman to try again...\nor fork this game and cheat\ngithub.com/leereilly/flappy-holman");instText.renderable=true;e=window.localStorage.getItem("hiscore");e=e?e:score;e=score>parseInt(e,10)?score:e;window.localStorage.setItem("hiscore",e);gameOverText.setText("End of Line\n\nHigh score:"+e);gameOverText.renderable=true;tubes.forEachAlive(function(e){e.body.velocity.x=0});invs.forEach(function(e){e.body.velocity.x=0});r.time.events.remove(tubesTimer);r.time.events.add(1e3,function(){return r.input.onTap.addOnce(function(){o();return swooshSnd.play()})});fallSnd.play()};n=function(){var e;if(!gameStarted){l()}if(!gameOver){bird.body.gravity.y=0;bird.body.velocity.y=-100;e=r.add.tween(bird.body.velocity).to({y:-FLAP},25,Phaser.Easing.Bounce.In,true);e.onComplete.add(function(){return bird.body.gravity.y=GRAVITY});flapSnd.play()}};fallsounds=function(e){var e=["sfx/fork.mp3","sfx/fork.mp3"];var t=Math.floor(Math.random()*e.length);var n=e[t];return n};i=function(){var e=document.createElement("audio");var t=fallsounds();if(e.canPlayType("audio/ogg")){assets={spritesheet:{bird:["gfx/flappy-holman.png",30,76]},image:{tubeTop:["gfx/tubeUP.png"],tubeBottom:["gfx/tubeDOWN.png"],ground:["gfx/pavement.png"],streetSign:["gfx/street-sign.png"],bg:["gfx/bg.png"]},audio:{flap:["sfx/push.ogg"],laugh:["sfx/merge.ogg"],fall:["sfx/fork.ogg"],swoosh:["sfx/restart.ogg"]}}}else{assets={spritesheet:{bird:["gfx/flappy-holman.png",30,76]},image:{tubeTop:["gfx/tubeUP.png"],tubeBottom:["gfx/tubeDOWN.png"],ground:["gfx/pavement.png"],streetSign:["gfx/street-sign.png"],bg:["gfx/bg.png"]},audio:{flap:["sfx/push.mp3"],laugh:["sfx/merge.mp3"],fall:["sfx/fork.mp3"],swoosh:["sfx/restart.mp3"]}}}Object.keys(assets).forEach(function(e){Object.keys(assets[e]).forEach(function(t){r.load[e].apply(r.load,[t].concat(assets[e][t]))})})};t=function(){Phaser.Canvas.setSmoothingEnabled(r.context,false);r.stage.scaleMode=Phaser.StageScaleMode.SHOW_ALL;r.stage.scale.setScreenSize(true);r.world.width=WIDTH;r.world.height=HEIGHT;bg=r.add.tileSprite(0,0,WIDTH,HEIGHT,"bg");credits=r.add.text(r.world.width/2,HEIGHT-GROUND_Y+50,"",{font:'8px "Press Start 2P"',fill:"#fff",stroke:"#430",strokeThickness:4,align:"center"});credits.anchor.x=.5;tubes=r.add.group();invs=r.add.group();bird=r.add.sprite(0,0,"bird");bird.anchor.setTo(.5,.5);bird.animations.add("fly",[0,1,2,3],8,true);bird.body.collideWorldBounds=true;bird.body.setPolygon(24,1,20,70,20,70,20,70,12,70,2,70,14,2);ground=r.add.tileSprite(0,GROUND_Y,WIDTH,GROUND_HEIGHT,"ground");ground.tileScale.setTo(SCALE,SCALE);scoreText=r.add.text(r.world.width/2,r.world.height/4,"",{font:'16px "Press Start 2P"',fill:"#fff",stroke:"#430",strokeThickness:3,align:"center"});scoreText.anchor.setTo(.5,.5);instText=r.add.text(r.world.width/2,r.world.height-r.world.height/4,"",{font:'8px "Press Start 2P"',fill:"#fff",stroke:"#430",strokeThickness:4,align:"center"});instText.anchor.setTo(.5,.5);gameOverText=r.add.text(r.world.width/2,r.world.height/2,"",{font:'16px "Press Start 2P"',fill:"#fff",stroke:"#430",strokeThickness:4,align:"center"});gameOverText.anchor.setTo(.5,.5);gameOverText.scale.setTo(SCALE,SCALE);flapSnd=r.add.audio("flap");scoreSnd=r.add.audio("laugh");fallSnd=r.add.audio("fall");swooshSnd=r.add.audio("swoosh");r.input.onDown.add(n);o()};o=function(){gameStarted=false;gameOver=false;score=0;streetSign=r.add.tileSprite(90,10,100,35,"streetSign");scoreText.setText("Flappy Holman");instText.setText("Touch @holman to start");gameOverText.renderable=false;bird.body.allowGravity=false;bird.reset(r.world.width*.3,r.world.height/2);bird.angle=0;bird.animations.play("fly");tubes.removeAll();invs.removeAll()};l=function(){r.world.remove(streetSign);credits.renderable=false;bird.body.allowGravity=true;bird.body.gravity.y=GRAVITY;tubesTimer=r.time.events.loop(1/SPAWN_RATE,f);scoreText.setText(score);instText.renderable=false;gameStarted=true};h=function(){console.log(window.innerWidth,window.innerHeight);var t;if(gameStarted){if(!gameOver){bird.angle=90*(FLAP+bird.body.velocity.y)/FLAP-180;if(bird.angle<-10){bird.angle=-10}if(bird.angle>5){bird.angle=5;bird.frame=1}else{bird.animations.play()}r.physics.overlap(bird,tubes,function(){u();return fallSnd.play()});if(!gameOver&&bird.body.bottom>=GROUND_Y){u()}r.physics.overlap(bird,invs,e)}else{t=r.add.tween(bird).to({angle:90},100,Phaser.Easing.Bounce.Out,true);if(bird.body.bottom>=GROUND_Y+3){bird.y=GROUND_Y-13;bird.body.velocity.y=0;bird.body.allowGravity=false;bird.body.gravity.y=0}}}else{bird.y=r.world.height/2+8*Math.cos(r.time.now/200);bird.angle=0}if(!gameOver){ground.tilePosition.x-=r.time.physicsElapsed*SPEED}};s=function(){if(DEBUG){r.debug.renderSpriteBody(bird);tubes.forEachAlive(function(e){r.debug.renderSpriteBody(e)});invs.forEach(function(e){r.debug.renderSpriteBody(e)})}};c={preload:i,create:t,update:h,render:s};r=new Phaser.Game(WIDTH,HEIGHT,Phaser.CANVAS,parent,c,false,false)};WebFontConfig={google:{families:["Press+Start+2P::latin"]},active:main};(function(){var e,t;t=document.createElement("script");t.src=("https:"===document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js";t.type="text/javascript";t.async="true";e=document.getElementsByTagName("script")[0];return e.parentNode.insertBefore(t,e)})()
